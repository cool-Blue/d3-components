<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <style>
    #viz {
      position: relative;
    }
    svg {
      outline: 1px solid red;
      overflow: visible;
      position: absolute;
    }
    .axis path {
      stroke: #000;
    }

    .axis line {
      stroke: steelblue;
      stroke-opacity: .5;
    }
    .axis path {
      fill: none;
    }
    .axis text {
      font-size: 8px;
    }
    .datum {
      fill: #ccc;
    }
    .datum.visible {
      fill: black;
    }
    #clipButton {
      position: absolute;
    }
  </style>
</head>
<body>
<div id="viz"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>-->
<script>
  var size = 500, r = 3;

  var margin = {top: 30, right: 40, bottom: 30, left: 50},
    width = 600 - margin.left - margin.right,
    height = 200 - margin.top - margin.bottom;

  var dataset = d3.range(100000).map(function(d, idx) {
    return {
      x: d3.random.normal(100 / 2, 100 / 4)(),
      y: d3.random.normal(100 / 2, 100 / 4)(),
      uuid: idx
    };
  });

  //
  // Init Scales
  //

  var xScale = d3.scale.linear()
      .domain([0, 100])
      .range([0, width])
      .nice(10);

  var yScale = d3.scale.linear()
    .domain([0, 100])
    .range([height, 0])
    .nice(10);

  //
  // Init Axes
  //

  var xAxis = d3.svg.axis()
    .scale(xScale)
    .ticks(10)
    .orient("bottom")
    .tickSize(-height);

  var yAxis = d3.svg.axis()
    .scale(yScale)
    .ticks(10)
    .orient("left")
    .tickSize(-width);

  //
  // Init Zoom
  //

  var d3Zoom = d3.behavior.zoom()
    .x(xScale)
    .y(yScale)
    .scaleExtent([0.99, Infinity])
    .on("zoom", semanticZoom)
//    .on("zoomend", updateSelection);

  var quadtree = d3.geom.quadtree(dataset);

  //------------------------ Callbacks --------------------------------

  function semanticZoom() {

    var s = 1;
    var t = [0, 0];
    if (d3.event) {
      s = (d3.event.scale) ? d3.event.scale : 1;
      t = (d3.event.translate) ? d3.event.translate : [0, 0];
    }

    var tl = [xScale.invert(0), yScale.invert(height)];
    var br = [xScale.invert(width), yScale.invert(0)];

    //
    // Store zoom extent
    //

    d3Zoom.extent = [tl, br];
    d3Zoom.scaleFactor = s;
    d3Zoom.translation = t;

    //
    // Update some heavy duty stuff
    // (create a quadtree, search that quadtree and update an attribute for the elements found)
    //

    // Prune non visible data
    var displayedData = search(quadtree, d3Zoom.extent);
    plotSurface.clearRect(0, 0, width, height);
    draw(displayedData, plotSurface);

    //
    // Update axes
    //

    d3.select(".x.axis").call(xAxis);
    d3.select(".y.axis").call(yAxis);

  };
  function draw(data, canvas) {
    var i = -1, n = data.length, d, cx, cy, w = r*2,
      stamp = document.createElement("canvas");
    stamp.height = stamp.width = w*2;
    var glyph = stamp.getContext("2d")
    glyph.globalAlpha = 0.8;
    glyph.beginPath();
    glyph.shadowColor = "steelblue";
    glyph.shadowOffsetX = glyph.shadowOffsetY = r;
    glyph.shadowBlur = 3;
    glyph.moveTo(w/2, w/2);
    glyph.arc(w/2, w/2, w/2, 0, 2 * Math.PI)
    glyph.fill()
    canvas.globalCompositeOperation = "multiply";
    canvas.beginPath();
    while (++i < n) {
      d = data[i];
      cx = xScale(d.x) - w/2;
      cy = yScale(d.y) - w/2;
//      canvas.fillRect(cx, cy, w, w)
      canvas.drawImage(stamp, cx, cy);
//      canvas.moveTo(cx, cy);
//      canvas.arc(cx, cy, 1, 0, 2 * Math.PI);
    }
    canvas.fill();
  }

  //
  // search quadtree
  //

  function search(qt, extent) {
    var pts = [],
        x0=extent[0][0], y0=extent[0][1],
      x3=extent[1][0], y3=extent[1][1];
    qt.visit(function(node, x1, y1, x2, y2) {
      var p = node.point;

      if ((p) && (p.x >= x0) && (p.x <= x3) && (p.y >= y0) && (p.y <= y3)) {
        pts.push(p);
      }

      return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
    });

    return pts;
  }

  //------------------------- DOM Manipulation -------------------------

  var svg = d3.select("#viz").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("class", "data_container")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")"),

    plotSurface = d3.select("#viz").append("div")
      .style({position: "absolute", cursor: "default",
        top: margin.top + "px", left: margin.left + "px",
        height: height + "px", width: width + "px"})
      .append("xhtml:canvas")
      .attr("class", "overlay")
      .attr("width", width)
      .attr("height", height)
      .style({position: "absolute", "pointer-events": "all"})
      .call(d3Zoom)
      .node().getContext("2d"),

    gX = svg.append("g")            // Add the X Axis
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis),

    gY = svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);

  semanticZoom();
</script>
</body>
</html>